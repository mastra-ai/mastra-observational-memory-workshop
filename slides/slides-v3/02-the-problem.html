<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Problem ‚Äî Observational Memory Workshop</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="shared.css">
    <style>
        /* ===== Drop sidebar, full width ===== */
        .page { display: block; }
        .main {
            margin-left: 0;
            max-width: 100%;
            padding: 0 4rem;
        }

        /* ===== Full-screen centered sections ===== */
        .section {
            max-width: 900px;
            margin: 0 auto;
        }

        .section.wide {
            max-width: 1100px;
        }

        /* ===== Intro text slider (matches insight page) ===== */
        #intro-thought {
            position: relative;
            overflow: hidden;
        }

        #intro-thought .section-label {
            position: relative;
            z-index: 2;
        }

        .intro-text {
            transition: opacity 0.3s ease;
            min-height: 3.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .intro-text.fading {
            opacity: 0;
        }

        .intro-scatter {
            position: absolute;
            inset: 0;
            z-index: 1;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }

        .intro-scatter.hidden {
            opacity: 0;
        }

        .scatter-item {
            position: absolute;
            font-size: 0.85rem;
            color: var(--text-dim);
            opacity: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 4px 12px;
            border-radius: 20px;
            white-space: nowrap;
            animation: scatterIn 0.5s ease forwards, scatterFloat 4s ease-in-out infinite;
        }

        @keyframes scatterIn {
            from { opacity: 0; transform: scale(0.8) translateY(0); }
            to { opacity: 0.65; transform: scale(1) translateY(0); }
        }

        @keyframes scatterFloat {
            0%, 100% { transform: translateY(0px) translateX(0px); }
            33% { transform: translateY(-14px) translateX(6px); }
            66% { transform: translateY(-6px) translateX(-8px); }
        }

        .intro-arrows {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: center;
        }

        .intro-arrow {
            background: none;
            border: 1px solid var(--border-light);
            color: var(--text-dim);
            font-size: 1.2rem;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-sans);
        }

        .intro-arrow:hover:not(:disabled) {
            color: var(--text-secondary);
            border-color: var(--text-dim);
        }

        .intro-arrow:disabled {
            opacity: 0.2;
            cursor: not-allowed;
        }

        /* ===== Retrieval animation ===== */
        .retrieval-demo {
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 1.5rem;
            height: calc(100vh - var(--topnav-height) - 6rem);
            min-height: 420px;
            max-height: 700px;
        }

        .retrieval-chat {
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            height: 100%;
        }

        .retrieval-chat-header {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-dim);
            border-bottom: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.02);
        }

        .retrieval-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
            min-height: 0;
        }

        .retrieval-context {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            height: 100%;
            overflow: hidden;
        }

        .retrieval-step {
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            flex: 1;
            min-height: 0;
        }

        .retrieval-step-header {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-dim);
            border-bottom: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.02);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .retrieval-step-content {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem 0.75rem;
            min-height: 0;
        }

        .cache-badge {
            font-size: 0.65rem;
            font-family: var(--font-mono);
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .cache-badge.miss {
            background: rgba(239, 68, 68, 0.15);
            color: var(--red);
        }

        .cache-badge.hit {
            background: rgba(34, 197, 94, 0.15);
            color: var(--green);
        }

        /* Reuse bar-item from shared for messages */
        .bar-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 2px 0;
            animation: fadeInMsg 0.3s ease;
        }

        @keyframes fadeInMsg {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bar-label {
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            width: 52px;
            flex-shrink: 0;
            text-align: right;
        }

        .bar-label.user { color: var(--yellow); }
        .bar-label.assistant { color: var(--accent); }
        .bar-label.tool { color: var(--orange); }
        .bar-label.retrieved { color: var(--accent); opacity: 0.6; }

        .bar-fill {
            height: 6px;
            border-radius: 3px;
            transition: width 0.3s ease;
            min-width: 8px;
        }

        .bar-fill.user { background: var(--yellow); opacity: 0.5; }
        .bar-fill.assistant { background: var(--accent); opacity: 0.4; }
        .bar-fill.tool { background: var(--orange); opacity: 0.6; }
        .bar-fill.retrieved { background: var(--accent); opacity: 0.25; }

        .bar-item.tool-bar .bar-fill {
            height: 10px;
            opacity: 0.7;
        }

        /* Context changing animation */
        .bar-item.shifting {
            animation: contextShift 0.4s ease;
        }

        @keyframes contextShift {
            0% { opacity: 0.3; transform: translateX(8px); }
            100% { opacity: 1; transform: translateX(0); }
        }

        .bar-item.removing {
            opacity: 0;
            transform: translateX(-20px);
            max-height: 0;
            padding: 0;
            margin: 0;
            overflow: hidden;
            transition: all 0.4s ease;
        }

        /* Retrieval query highlight */
        .query-flash {
            animation: queryFlash 0.6s ease;
        }

        @keyframes queryFlash {
            0% { background: rgba(99, 102, 241, 0.2); }
            100% { background: transparent; }
        }

        /* Demo controls */
        .demo-controls {
            display: flex;
            align-items: center;
            gap: 1.25rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .demo-btn {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.65rem 1.4rem;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            font-family: var(--font-sans);
            transition: background 0.2s;
        }

        .demo-btn:hover { background: var(--accent-hover); }
        .demo-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .demo-btn.reset {
            background: transparent;
            border: 1px solid var(--border-light);
            color: var(--text-dim);
        }
        .demo-btn.reset:hover { color: var(--text-secondary); border-color: var(--text-dim); }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.82rem;
            color: var(--text-dim);
        }
        .speed-control input[type="range"] { width: 80px; accent-color: var(--accent); }

        .section.demo-section {
            padding: 1rem 0;
            justify-content: flex-start;
            min-height: unset;
        }

        /* ===== Noise Animation ===== */
        .noise-stage {
            display: flex;
            align-items: center;
            gap: 2rem;
            justify-content: center;
            height: 420px;
            position: relative;
        }

        .noise-stream {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 340px;
            max-height: 400px;
            overflow-y: auto;
        }

        .noise-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 5px 14px;
            border-radius: 8px;
            font-size: 0.9rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            animation: slideInRight 0.3s ease;
            white-space: nowrap;
        }

        .noise-item .noise-type {
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            width: 44px;
            flex-shrink: 0;
        }

        .noise-item .noise-bar {
            border-radius: 3px;
            flex-shrink: 0;
        }

        .noise-item .noise-text {
            font-size: 0.8rem;
            color: var(--text-dim);
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Type colors */
        .noise-item.type-user .noise-type { color: var(--yellow); }
        .noise-item.type-user .noise-bar { background: var(--yellow); opacity: 0.5; height: 6px; width: 40px; }

        .noise-item.type-assistant .noise-type { color: var(--accent); }
        .noise-item.type-assistant .noise-bar { background: var(--accent); opacity: 0.4; height: 6px; width: 60px; }

        .noise-item.type-tool .noise-type { color: var(--orange); }
        .noise-item.type-tool .noise-bar { background: var(--orange); opacity: 0.7; height: 12px; width: 160px; }
        .noise-item.type-tool { border-color: rgba(249, 115, 22, 0.2); }

        .noise-item.type-memory .noise-type { color: var(--accent); opacity: 0.6; }
        .noise-item.type-memory .noise-bar { background: var(--accent); opacity: 0.25; height: 8px; width: 100px; }

        .noise-item.fading {
            opacity: 0.15;
            transform: scale(0.95);
            transition: all 0.5s ease;
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .noise-result-columns {
            display: flex;
            gap: 2rem;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .noise-result-columns.visible {
            opacity: 1;
        }

        .noise-signal, .noise-junk {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 200px;
            max-height: 400px;
            overflow-y: auto;
        }

        .noise-col-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .noise-col-label.green { color: var(--green); }
        .noise-col-label.red { color: var(--red); }

        .noise-signal-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 5px 14px;
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--green);
            background: var(--green-dim);
            border: 1px solid rgba(34, 197, 94, 0.15);
            animation: slideInRight 0.3s ease;
            white-space: nowrap;
        }

        .noise-junk-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 5px 14px;
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--red);
            background: var(--red-dim);
            border: 1px solid rgba(239, 68, 68, 0.15);
            animation: slideInRight 0.3s ease;
            white-space: nowrap;
            opacity: 0.7;
        }

        /* ===== Retrieval flow diagram ===== */
        .retrieval-flow {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .flow-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.2rem 1.4rem;
            min-width: 100px;
            transition: border-color 0.3s;
        }

        .flow-icon {
            font-size: 1.6rem;
        }

        .flow-label {
            font-size: 0.82rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-align: center;
            white-space: nowrap;
        }

        .flow-arrow {
            font-size: 1.4rem;
            color: var(--text-dim);
            opacity: 0.5;
        }

        /* Bridge scatter: red miss badges */
        .scatter-miss {
            position: absolute;
            font-size: 0.7rem;
            font-weight: 700;
            font-family: var(--font-mono);
            color: var(--red);
            background: var(--red-dim);
            border: 1px solid rgba(239, 68, 68, 0.2);
            padding: 3px 10px;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            animation: scatterIn 0.5s ease forwards, scatterFloat 4s ease-in-out infinite;
        }

        /* Bridge scatter: disconnected memory fragments */
        .scatter-fragment {
            position: absolute;
            font-size: 0.82rem;
            color: var(--text-dim);
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 4px 12px;
            border-radius: 20px;
            white-space: nowrap;
            opacity: 0;
            animation: scatterIn 0.5s ease forwards, scatterFloat 4s ease-in-out infinite;
        }

        /* Bridge scatter: green signal pills crowding */
        .scatter-signal {
            position: absolute;
            font-size: 0.78rem;
            color: var(--green);
            background: var(--green-dim);
            border: 1px solid rgba(34, 197, 94, 0.15);
            padding: 3px 10px;
            border-radius: 20px;
            white-space: nowrap;
            opacity: 0;
            animation: scatterIn 0.5s ease forwards, scatterFloat 3s ease-in-out infinite;
        }

        /* Inline note */
        .inline-note {
            font-size: 1rem;
            color: var(--text-dim);
            max-width: 700px;
            line-height: 1.6;
            margin-top: 1.5rem;
        }

        .inline-note strong { color: var(--text-secondary); }
    </style>
</head>
<body>

<!-- Top Navigation -->
<nav class="topnav">
    <a href="01-intro.html" class="topnav-brand">OM Workshop</a>
    <div class="topnav-sections">
        <a href="01-intro.html">Intro</a>
        <a href="02-the-problem.html" class="active">The Problem</a>
        <a href="03-the-insight.html">The Insight</a>
        <a href="04-the-proof.html">The Proof</a>
        <a href="05-whats-next.html">What's Next</a>
        <a href="06-demo.html">Demo</a>
    </div>
    <div class="topnav-nav">
        <a href="01-intro.html">‚Üê prev</a>
        <a href="03-the-insight.html">next ‚Üí</a>
    </div>
</nav>

<div class="page">
    <main class="main">

        <!-- Section 1: Big-text intro with arrows -->
        <div class="section" id="intro-thought">
            <div class="intro-scatter" id="intro-scatter"></div>
            <p class="section-label">The Problem</p>
            <h2 class="intro-text" id="intro-text">LLMs can process enormous amounts of information in a single pass.</h2>
            <div class="intro-arrows">
                <button class="intro-arrow" id="intro-prev" disabled>‚Üê</button>
                <button class="intro-arrow" id="intro-next">‚Üí</button>
                <button class="intro-arrow" id="intro-continue" style="display:none;">‚Üì</button>
            </div>
        </div>

        <!-- Section 1b: Context fills up with noise (auto-play on scroll) -->
        <div class="section" id="noise-demo">
            <h2 id="noise-heading">What goes into an agent's context?</h2>

            <div class="noise-stage mt-4">
                <div class="noise-stream" id="noise-stream"></div>
                <div class="noise-result-columns" id="noise-results">
                    <div class="noise-signal" id="noise-signal">
                        <div class="noise-col-label green">Signal</div>
                    </div>
                    <div class="noise-junk" id="noise-junk">
                        <div class="noise-col-label red">Noise</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 1c: Bridge to retrieval (arrow text slider) -->
        <div class="section" id="retrieval-bridge" style="position:relative; overflow:hidden;">
            <div class="intro-scatter" id="bridge-scatter-0"></div>
            <div class="intro-scatter hidden" id="bridge-scatter-1"></div>
            <div class="intro-scatter hidden" id="bridge-scatter-2"></div>
            <div class="intro-scatter hidden" id="bridge-scatter-3"></div>
            <h2 class="intro-text" id="bridge-text" style="position:relative; z-index:2;">The most common solution: extract the signal, then dynamically inject it per turn.</h2>
            <div class="intro-arrows" style="position:relative; z-index:2;">
                <button class="intro-arrow" id="bridge-prev" disabled>‚Üê</button>
                <button class="intro-arrow" id="bridge-next">‚Üí</button>
                <button class="intro-arrow" id="bridge-continue" style="display:none;">‚Üì</button>
            </div>
        </div>

        <!-- Section 1d: Retrieval architecture -->
        <div class="section" id="retrieval-arch">
            <p class="section-label">The retrieval pattern</p>
            <h2>Every turn, the same pipeline runs</h2>

            <div class="retrieval-flow mt-4 fade-on-scroll">
                <div class="flow-step">
                    <div class="flow-icon">üí¨</div>
                    <div class="flow-label">User Message</div>
                </div>
                <div class="flow-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-icon">üî¢</div>
                    <div class="flow-label">Embed</div>
                </div>
                <div class="flow-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-icon">üóÉÔ∏è</div>
                    <div class="flow-label">Query Vector DB</div>
                </div>
                <div class="flow-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-icon">üìä</div>
                    <div class="flow-label">Rank Results</div>
                </div>
                <div class="flow-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-icon">üíâ</div>
                    <div class="flow-label">Inject into Context</div>
                </div>
                <div class="flow-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-icon">ü§ñ</div>
                    <div class="flow-label">LLM</div>
                </div>
            </div>

            <p class="inline-note" style="text-align:center; margin-top:2rem;">
                Different context every turn. Different results every query. No continuity.
            </p>
        </div>

        <!-- Section 2: Retrieval animation -->
        <div class="section wide demo-section" id="retrieval-demo-section">
            <h2>Watch it happen</h2>
            <p class="inline-note" style="margin-top:0; margin-bottom:1.5rem;">
                Every turn: query a database, inject retrieved context, hope the model gets what it needs.
            </p>

            <div class="demo-controls">
                <button class="demo-btn" id="demo-start">‚ñ∂ Start</button>
                <button class="demo-btn" id="demo-pause" style="display:none;">‚è∏ Pause</button>
                <button class="demo-btn reset" id="demo-reset" style="display:none;">‚Ü∫ Reset</button>
                <div class="speed-control">
                    <label>Speed:</label>
                    <input type="range" id="speed-slider" min="1" max="5" value="3">
                    <span id="speed-label">1√ó</span>
                </div>
            </div>

            <div class="retrieval-demo" id="retrieval-demo">
                <!-- Left: Chat -->
                <div class="retrieval-chat">
                    <div class="retrieval-chat-header">Chat ‚Äî what the user sees</div>
                    <div class="retrieval-chat-messages chat-messages" id="ret-chat"></div>
                </div>

                <!-- Right: Context Window -->
                <div class="retrieval-context">
                    <div class="retrieval-step" style="flex: 0 0 auto; max-height: 80px;">
                        <div class="retrieval-step-header">
                            <span>Query</span>
                        </div>
                        <div class="retrieval-step-content" id="ret-query" style="display:flex; align-items:center;">
                            <span style="font-size: 0.85rem; color: var(--text-dim); font-style: italic;">Waiting...</span>
                        </div>
                    </div>
                    <div class="retrieval-step" style="flex: 0 0 auto;">
                        <div class="retrieval-step-header">
                            <span>Retrieved Context</span>
                            <span class="cache-badge miss" id="ret-cache" style="opacity:0;">MISS</span>
                        </div>
                        <div class="retrieval-step-content" id="ret-context"></div>
                    </div>
                    <div class="retrieval-step">
                        <div class="retrieval-step-header">
                            <span>Message History</span>
                        </div>
                        <div class="retrieval-step-content" id="ret-messages"></div>
                    </div>
                </div>
            </div>

            <p class="inline-note" id="ret-note" style="text-align:center; opacity:0; transition: opacity 0.5s;">
                Context changes every turn. <strong>Cache miss every time.</strong> The more data stored, the noisier the retrieval.
            </p>
        </div>

    </main>
</div>

<script src="shared.js"></script>
<script>
// ===== INTRO TEXT SLIDER =====
(function () {
    const slides = [
        'LLMs can process enormous amounts of information in a single pass.',
        'But their memory over long sessions is significantly worse than ours.',
        'Our theory: these two things are related.',
    ];

    // Scatter: retrieval-related noise items
    const scatterItems = [
        'üîç query: "user preferences"',
        'üìä similarity: 0.82',
        'üóÉÔ∏è chunk_id: 4a8f2c',
        'üìé metadata.source: thread-47',
        'üî¢ rank: 3 of 12',
        'üìä similarity: 0.71',
        'üóÉÔ∏è chunk_id: 9b3e7d',
        'üîç query: "flight booking"',
        'üìé metadata.source: thread-12',
        'üî¢ rank: 7 of 12',
        'üìä similarity: 0.63',
        'üóÉÔ∏è chunk_id: 2f1a8e',
    ];

    const scatterEl = document.getElementById('intro-scatter');
    const textEl = document.getElementById('intro-text');
    const prevBtn = document.getElementById('intro-prev');
    const nextBtn = document.getElementById('intro-next');
    const continueBtn = document.getElementById('intro-continue');
    let idx = 0;

    const positions = [
        { top: '8%',  left: '4%' },
        { top: '10%', right: '6%' },
        { top: '25%', left: '2%' },
        { top: '22%', right: '3%' },
        { top: '62%', left: '5%' },
        { top: '68%', right: '4%' },
        { top: '80%', left: '3%' },
        { top: '76%', right: '8%' },
        { top: '42%', left: '1%' },
        { top: '48%', right: '2%' },
        { top: '90%', left: '10%' },
        { top: '88%', right: '12%' },
    ];

    // Build scatter items
    scatterItems.forEach((text, i) => {
        const el = document.createElement('div');
        el.className = 'scatter-item';
        el.textContent = text;
        const delay = i * 0.1;
        const floatDur = 3.5 + (i % 4) * 0.5;
        const floatDelay = (i * 0.3) % 2;
        el.style.animation = `scatterIn 0.5s ${delay}s ease forwards, scatterFloat ${floatDur}s ${floatDelay}s ease-in-out infinite`;
        const pos = positions[i % positions.length];
        if (pos.top) el.style.top = pos.top;
        if (pos.left) el.style.left = pos.left;
        if (pos.right) el.style.right = pos.right;
        scatterEl.appendChild(el);
    });

    // Show scatter only on slide 1 (the "worse than ours" slide)
    function show(newIdx) {
        textEl.classList.add('fading');
        setTimeout(() => {
            idx = newIdx;
            textEl.textContent = slides[idx];
            textEl.classList.remove('fading');
            prevBtn.disabled = idx === 0;
            nextBtn.disabled = idx === slides.length - 1;
            // Scatter visible on slide 1 (memory is worse)
            scatterEl.classList.toggle('hidden', idx !== 1);
            const isLast = idx === slides.length - 1;
            nextBtn.style.display = isLast ? 'none' : '';
            continueBtn.style.display = isLast ? '' : 'none';
        }, 300);
    }

    prevBtn.onclick = () => { if (idx > 0) show(idx - 1); };
    nextBtn.onclick = () => { if (idx < slides.length - 1) show(idx + 1); };
    continueBtn.onclick = () => {
        document.getElementById('noise-demo').scrollIntoView({ behavior: 'smooth' });
    };
})();

// ===== NOISE ANIMATION (auto-play on scroll) =====
(function () {
    const items = [
        { type: 'user',      signal: true,  label: 'USER', text: '"Book a flight to NYC"' },
        { type: 'assistant', signal: true,  label: 'ASST', text: '"Searching for flights‚Ä¶"' },
        { type: 'tool',      signal: false, label: 'TOOL', text: '{"flights":[{"airline":"Delta","flight":"DL1234","price":342.50,"cabin":"economy","stops":0,...}]}' },
        { type: 'assistant', signal: true,  label: 'ASST', text: '"Delta, $342, direct"' },
        { type: 'memory',     signal: false, label: 'MEMORY', text: 'prev trip to SF ‚Äî July 2025 (similarity: 0.72)' },
        { type: 'user',      signal: true,  label: 'USER', text: '"Find a hotel nearby"' },
        { type: 'tool',      signal: false, label: 'TOOL', text: '{"hotels":[{"name":"Marriott JFK","rate":189,"rating":4.2,"amenities":["pool","gym","wifi"],...}]}' },
        { type: 'memory',     signal: false, label: 'MEMORY', text: 'hotel comparison notes ‚Äî SF trip (similarity: 0.68)' },
        { type: 'memory',     signal: false, label: 'MEMORY', text: 'loyalty program details (similarity: 0.61)' },
        { type: 'assistant', signal: true,  label: 'ASST', text: '"Marriott JFK, $189/night"' },
        { type: 'user',      signal: true,  label: 'USER', text: '"Do I have dietary restrictions?"' },
        { type: 'tool',      signal: false, label: 'TOOL', text: '{"results":[{"text":"User mentioned vegetarian in conv #12","score":0.82,"metadata":{...}}]}' },
        { type: 'memory',     signal: false, label: 'MEMORY', text: 'grocery list from conv #5 (similarity: 0.59)' },
        { type: 'assistant', signal: true,  label: 'ASST', text: '"You\'re vegetarian"' },
        { type: 'user',      signal: true,  label: 'USER', text: '"What was the hotel price?"' },
        { type: 'memory',     signal: false, label: 'MEMORY', text: 'hotels near LAX ‚Äî conv #8 (similarity: 0.71)' },
        { type: 'tool',      signal: false, label: 'TOOL', text: '{"results":[{"text":"Hotels near LAX from conv #8","score":0.71,...}]}' },
        { type: 'assistant', signal: false, label: 'ASST', text: '"Hmm, I found hotels near LAX‚Ä¶"' },
    ];

    const stream = document.getElementById('noise-stream');
    const results = document.getElementById('noise-results');
    const signalEl = document.getElementById('noise-signal');
    const junkEl = document.getElementById('noise-junk');
    const heading = document.getElementById('noise-heading');

    let played = false;

    async function playAll() {
        if (played) return;
        played = true;

        await new Promise(r => setTimeout(r, 800));

        // Step 1: Stream items in
        const domItems = [];
        for (const item of items) {
            const el = document.createElement('div');
            el.className = 'noise-item type-' + item.type;
            el.innerHTML = '<span class="noise-type">' + item.label + '</span><span class="noise-bar"></span><span class="noise-text">' + item.text + '</span>';
            el.dataset.signal = item.signal ? '1' : '0';
            stream.appendChild(el);
            domItems.push(el);
            stream.scrollTop = stream.scrollHeight;
            await new Promise(r => setTimeout(r, 200));
        }

        await new Promise(r => setTimeout(r, 800));

        // Step 2: Fade non-signal items + update heading
        heading.textContent = 'Most of it is noise.';
        for (const el of domItems) {
            if (el.dataset.signal === '0') {
                el.classList.add('fading');
            }
        }

        await new Promise(r => setTimeout(r, 1000));

        // Step 3: Show signal vs noise columns
        results.classList.add('visible');
        const signals = items.filter(i => i.signal);
        const noise = items.filter(i => !i.signal);

        const maxLen = Math.max(signals.length, noise.length);
        for (let i = 0; i < maxLen; i++) {
            if (i < signals.length) {
                const el = document.createElement('div');
                el.className = 'noise-signal-item';
                el.textContent = signals[i].text;
                signalEl.appendChild(el);
            }
            if (i < noise.length) {
                const el = document.createElement('div');
                el.className = 'noise-junk-item';
                el.textContent = noise[i].label + ' ‚Äî ' + noise[i].text.slice(0, 40) + '‚Ä¶';
                junkEl.appendChild(el);
            }
            await new Promise(r => setTimeout(r, 120));
        }
    }

    const observer = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting && !played) {
            playAll();
        }
    }, { threshold: 0.85 });

    observer.observe(document.getElementById('noise-demo'));
})();

// ===== BRIDGE TEXT SLIDER =====
(function () {
    const slides = [
        'The most common solution: extract the signal, then dynamically inject it per turn.',
        'This constantly invalidates the prompt cache. Every turn is a cache miss.',
        'The LLM never builds a rich, continuous picture. Memories are injected to steer a single turn ‚Äî not the overall behaviour.',
        'And what happens when you have too much signal? How do you decide what doesn\'t matter anymore?',
    ];

    // Scatter data per slide
    const scatterData = [
        // Slide 0: retrieval noise pills
        { el: 'bridge-scatter-0', cls: 'scatter-item', items: [
            'üîç query: "preferences"', 'üìä similarity: 0.72', 'üóÉÔ∏è chunk_id: 4a8f2c',
            'üìé source: thread-47', 'üî¢ rank: 3 of 12', 'üìä similarity: 0.61',
            'üóÉÔ∏è chunk_id: 9b3e7d', 'üîç query: "bookings"', 'üìé source: thread-12',
            'üî¢ rank: 7 of 12', 'üìä similarity: 0.55', 'üóÉÔ∏è chunk_id: 2f1a8e',
        ]},
        // Slide 1: red MISS badges
        { el: 'bridge-scatter-1', cls: 'scatter-miss', items: [
            'MISS', 'MISS', 'MISS', 'MISS', 'MISS', 'MISS',
            'MISS', 'MISS', 'MISS', 'MISS', 'MISS', 'MISS',
        ]},
        // Slide 2: disconnected memory fragments
        { el: 'bridge-scatter-2', cls: 'scatter-fragment', items: [
            'üìç likes sushi', '‚úàÔ∏è flew to NYC', 'üè® Marriott JFK',
            'ü•¨ vegetarian', 'üí∞ budget: $2k', 'üéµ plays guitar',
            'üêï has a dog', 'üì± prefers SMS', 'üèÉ runs mornings',
            '‚òï oat milk latte', 'üé¨ sci-fi fan', 'üöó drives a Tesla',
        ]},
        // Slide 3: green signal pills crowding
        { el: 'bridge-scatter-3', cls: 'scatter-signal', items: [
            '‚úÖ vegetarian', '‚úÖ NYC flight Mar 15', '‚úÖ Marriott $189',
            '‚úÖ budget $2k', '‚úÖ window seat', '‚úÖ Delta loyalty',
            '‚úÖ oat milk allergy', '‚úÖ prefers mornings', '‚úÖ SF trip Jul',
            '‚úÖ guitar lessons Tue', '‚úÖ dog: Max', '‚úÖ Tesla Model 3',
            '‚úÖ runs at 6am', '‚úÖ sci-fi books', '‚úÖ SMS not email',
            '‚úÖ partner: Alex', '‚úÖ peanut allergy', '‚úÖ yoga Thursdays',
        ]},
    ];

    const positions = [
        { top: '6%',  left: '3%' },  { top: '8%', right: '5%' },
        { top: '22%', left: '1%' },  { top: '20%', right: '2%' },
        { top: '38%', left: '4%' },  { top: '40%', right: '3%' },
        { top: '56%', left: '2%' },  { top: '54%', right: '6%' },
        { top: '70%', left: '5%' },  { top: '68%', right: '4%' },
        { top: '82%', left: '3%' },  { top: '84%', right: '7%' },
        { top: '14%', left: '8%' },  { top: '30%', right: '9%' },
        { top: '48%', left: '7%' },  { top: '62%', right: '8%' },
        { top: '76%', left: '9%' },  { top: '90%', right: '5%' },
    ];

    // Build all scatter layers
    scatterData.forEach(layer => {
        const container = document.getElementById(layer.el);
        layer.items.forEach((text, i) => {
            const el = document.createElement('div');
            el.className = layer.cls;
            el.textContent = text;
            const delay = i * 0.08;
            const floatDur = 3.5 + (i % 4) * 0.5;
            const floatDelay = (i * 0.3) % 2;
            el.style.animation = `scatterIn 0.5s ${delay}s ease forwards, scatterFloat ${floatDur}s ${floatDelay}s ease-in-out infinite`;
            const pos = positions[i % positions.length];
            if (pos.top) el.style.top = pos.top;
            if (pos.left) el.style.left = pos.left;
            if (pos.right) el.style.right = pos.right;
            container.appendChild(el);
        });
    });

    const scatterEls = scatterData.map(d => document.getElementById(d.el));
    const textEl = document.getElementById('bridge-text');
    const prevBtn = document.getElementById('bridge-prev');
    const nextBtn = document.getElementById('bridge-next');
    const continueBtn = document.getElementById('bridge-continue');
    let idx = 0;

    function show(newIdx) {
        textEl.classList.add('fading');
        setTimeout(() => {
            idx = newIdx;
            textEl.textContent = slides[idx];
            textEl.classList.remove('fading');
            prevBtn.disabled = idx === 0;
            nextBtn.disabled = idx === slides.length - 1;
            // Show matching scatter, hide others
            scatterEls.forEach((el, i) => el.classList.toggle('hidden', i !== idx));
            const isLast = idx === slides.length - 1;
            nextBtn.style.display = isLast ? 'none' : '';
            continueBtn.style.display = isLast ? '' : 'none';
        }, 300);
    }

    prevBtn.onclick = () => { if (idx > 0) show(idx - 1); };
    nextBtn.onclick = () => { if (idx < slides.length - 1) show(idx + 1); };
    continueBtn.onclick = () => {
        document.getElementById('retrieval-arch').scrollIntoView({ behavior: 'smooth' });
    };
})();

// ===== RETRIEVAL ANIMATION =====
(function () {
    const script = [
        { role: 'user', text: 'Book me a flight to NYC next Friday', query: 'Book me a flight to NYC next Friday', tokens: 40 },
        { role: 'assistant', text: 'Let me search for flights...', tokens: 30 },
        { role: 'tool', text: '{"flights": [{"airline":"Delta","flight":"DL1234","price":342.50,...}]}', tokens: 180 },
        { role: 'assistant', text: 'Found a Delta flight for $342. Want to book?', tokens: 35 },
        { role: 'user', text: 'Yes, and find a hotel nearby', query: 'Yes, and find a hotel nearby', tokens: 38 },
        { role: 'tool', text: '{"hotels": [{"name":"Marriott JFK","rate":189.00,"rating":4.2,...}]}', tokens: 200 },
        { role: 'assistant', text: 'Marriott JFK for $189/night. Good reviews.', tokens: 32 },
        { role: 'user', text: 'Actually, remind me ‚Äî do I have any dietary restrictions?', query: 'Actually, remind me ‚Äî do I have any dietary restrictions?', tokens: 42 },
        { role: 'tool', text: '{"results": [{"text":"User mentioned being vegetarian in conv #12",...}]}', tokens: 160 },
        { role: 'assistant', text: 'You mentioned being vegetarian.', tokens: 28 },
        { role: 'user', text: 'What was the hotel price again?', query: 'What was the hotel price again?', tokens: 35 },
        { role: 'tool', text: '{"results": [{"text":"Hotels near LAX from conv #8","score":0.71,...}]}', tokens: 190 },
        { role: 'assistant', text: 'Hmm, I found hotels near LAX... let me re-check for NYC.', tokens: 40 },
    ];

    // Simulated retrieved context that changes every query
    const retrievedContexts = [
        [
            { label: 'MEMORY', w: '65%', text: 'prev trip to SF ‚Äî July 2025' },
            { label: 'MEMORY', w: '80%', text: 'flight search API docs' },
            { label: 'MEMORY', w: '45%', text: 'user prefers window seats' },
        ],
        [
            { label: 'MEMORY', w: '75%', text: 'hotel comparison ‚Äî SF trip' },
            { label: 'MEMORY', w: '55%', text: 'JFK airport terminal info' },
            { label: 'MEMORY', w: '90%', text: 'loyalty program details' },
            { label: 'MEMORY', w: '40%', text: 'credit card rewards' },
        ],
        [
            { label: 'MEMORY', w: '50%', text: 'grocery list from conv #5' },
            { label: 'MEMORY', w: '70%', text: 'vegetarian since Jan ‚Äî conv #12' },
            { label: 'MEMORY', w: '35%', text: 'restaurant recs ‚Äî conv #19' },
        ],
        [
            { label: 'MEMORY', w: '85%', text: 'hotels near LAX ‚Äî conv #8' },
            { label: 'MEMORY', w: '60%', text: 'budget for travel: $2k' },
            { label: 'MEMORY', w: '45%', text: 'Airbnb comparison notes' },
        ],
    ];

    const chat = document.getElementById('ret-chat');
    const queryEl = document.getElementById('ret-query');
    const contextEl = document.getElementById('ret-context');
    const messagesEl = document.getElementById('ret-messages');
    const cacheEl = document.getElementById('ret-cache');
    const noteEl = document.getElementById('ret-note');
    const startBtn = document.getElementById('demo-start');
    const pauseBtn = document.getElementById('demo-pause');
    const resetBtn = document.getElementById('demo-reset');
    const speedSlider = document.getElementById('speed-slider');
    const speedLabel = document.getElementById('speed-label');

    let running = false;
    let paused = false;
    let scriptIdx = 0;
    let queryIdx = 0;
    let missCount = 0;

    function getDelay() {
        const speeds = [2000, 1500, 1000, 600, 300];
        const v = parseInt(speedSlider.value) - 1;
        return speeds[v] || 1000;
    }

    speedSlider.oninput = () => {
        const labels = ['0.5√ó', '0.75√ó', '1√ó', '1.5√ó', '2√ó'];
        speedLabel.textContent = labels[parseInt(speedSlider.value) - 1] || '1√ó';
    };

    function wait(ms) {
        if (!ms) ms = getDelay();
        return new Promise(r => {
            (function check() {
                if (!running) return;
                if (paused) { setTimeout(check, 100); return; }
                setTimeout(r, ms);
            })();
        });
    }

    function makeBar(role, text) {
        const el = document.createElement('div');
        el.className = `bar-item ${role === 'tool' ? 'tool-bar' : ''}`;
        const lbl = document.createElement('div');
        lbl.className = `bar-label ${role}`;
        lbl.textContent = role === 'assistant' ? 'ASST' : role.toUpperCase();
        const fill = document.createElement('div');
        const tokW = Math.min(95, Math.max(15, text.length * 0.6));
        fill.className = `bar-fill ${role}`;
        fill.style.width = tokW + '%';
        el.appendChild(lbl);
        el.appendChild(fill);
        return el;
    }

    function addChatMsg(role, text) {
        const d = document.createElement('div');
        if (role === 'tool') {
            d.className = 'chat-bubble system-event';
            d.textContent = 'üîß tool call';
        } else {
            d.className = 'chat-bubble ' + role;
            d.textContent = text;
        }
        chat.appendChild(d);
        chat.scrollTop = chat.scrollHeight;
    }

    function addContextMsg(role, text) {
        messagesEl.appendChild(makeBar(role, text));
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function setQuery(text) {
        queryEl.innerHTML = '';
        if (!text) {
            queryEl.innerHTML = '<span style="font-size:0.85rem;color:var(--text-dim);font-style:italic;">Waiting...</span>';
            return;
        }
        const el = document.createElement('div');
        el.style.cssText = 'font-size:0.85rem; font-family:var(--font-mono); color:var(--accent);';
        el.textContent = 'üîç ' + text;
        el.className = 'query-flash';
        queryEl.appendChild(el);
    }

    function setRetrievedContext(chunks) {
        // Animate out old context
        const oldItems = contextEl.querySelectorAll('.bar-item');
        oldItems.forEach(el => el.classList.add('removing'));

        setTimeout(() => {
            contextEl.innerHTML = '';
            chunks.forEach(chunk => {
                const el = document.createElement('div');
                el.className = 'bar-item shifting';
                const lbl = document.createElement('div');
                lbl.className = 'bar-label retrieved';
                lbl.textContent = chunk.label;
                const fill = document.createElement('div');
                fill.className = 'bar-fill retrieved';
                fill.style.width = chunk.w;
                const txt = document.createElement('span');
                txt.style.cssText = 'font-size:0.72rem; color:var(--text-dim); margin-left:0.3rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;';
                txt.textContent = chunk.text;
                el.appendChild(lbl);
                el.appendChild(fill);
                el.appendChild(txt);
                contextEl.appendChild(el);
            });
        }, 300);
    }

    function flashCache() {
        missCount++;
        cacheEl.style.opacity = '1';
        cacheEl.textContent = 'MISS';
        cacheEl.className = 'cache-badge miss';
        cacheEl.style.animation = 'none';
        cacheEl.offsetHeight; // reflow
        cacheEl.style.animation = 'queryFlash 0.6s ease';
    }

    async function run() {
        running = true;
        startBtn.style.display = 'none';
        pauseBtn.style.display = '';
        resetBtn.style.display = '';

        while (running) {
            const step = script[scriptIdx % script.length];

            addChatMsg(step.role, step.text);
            addContextMsg(step.role, step.text);
            await wait();

            // If this step has a query, do the retrieval dance
            if (step.query) {
                setQuery(step.query);
                await wait(getDelay() * 0.6);
                setRetrievedContext(retrievedContexts[queryIdx % retrievedContexts.length]);
                flashCache();
                queryIdx++;
                await wait(getDelay() * 0.4);
            }

            scriptIdx++;

            // Show note after first few cache misses
            if (missCount >= 2 && noteEl.style.opacity === '0') {
                noteEl.style.opacity = '1';
            }
        }
    }

    function reset() {
        running = false;
        paused = false;
        scriptIdx = 0;
        queryIdx = 0;
        missCount = 0;
        chat.innerHTML = '';
        contextEl.innerHTML = '';
        messagesEl.innerHTML = '';
        setQuery(null);
        cacheEl.style.opacity = '0';
        noteEl.style.opacity = '0';
        startBtn.style.display = '';
        pauseBtn.style.display = 'none';
        resetBtn.style.display = 'none';
        pauseBtn.textContent = '‚è∏ Pause';
    }

    startBtn.onclick = () => run();
    pauseBtn.onclick = () => {
        paused = !paused;
        pauseBtn.textContent = paused ? '‚ñ∂ Resume' : '‚è∏ Pause';
    };
    resetBtn.onclick = () => reset();
})();
</script>

</body>
</html>
